workflows:
  ios-workflow:
    name: iOS Release
    instance_type: mac_mini_m2
    max_build_duration: 60
    environment:
      flutter: stable
      xcode: latest
      cocoapods: default
    scripts:
      - name: Get Flutter packages
        script: |
          flutter pub get
      - name: Build Unsigned IPA
        script: |
          # 1. Build the iOS app
          flutter build ios --release --no-codesign

          # 2. The .app is built to this specific location
          APP_PATH="build/ios/iphoneos/Runner.app"

          # 3. Verify the app bundle exists and contains an executable
          if [ ! -d "$APP_PATH" ]; then
            echo "ERROR: Runner.app not found at $APP_PATH"
            find build -name "*.app" -type d
            exit 1
          fi

          if [ ! -f "$APP_PATH/Runner" ]; then
            echo "ERROR: Runner executable not found inside app bundle"
            ls -la "$APP_PATH"
            exit 1
          fi

          echo "App bundle found with contents:"
          ls -la "$APP_PATH"

          # 4. Fake-sign all binaries for AltStore compatibility
          echo "Fake-signing app bundle for AltStore..."

          # Sign the main executable
          /usr/bin/codesign --force --deep --sign - "$APP_PATH"

          # Sign all frameworks
          find "$APP_PATH/Frameworks" -name "*.framework" -type d | while read framework; do
            echo "Signing framework: $framework"
            /usr/bin/codesign --force --deep --sign - "$framework"
          done

          echo "Fake-signing complete"

          # 5. Prepare the Payload folder structure
          rm -rf Payload
          mkdir -p Payload

          # 6. Copy the app bundle (preserve symlinks with -R)
          cp -R "$APP_PATH" Payload/

          # 7. Create the IPA (zip with symlinks preserved)
          zip -r -y Runner.ipa Payload

          # 8. Verify IPA structure
          echo "IPA contents:"
          unzip -l Runner.ipa | head -20

          # 9. Move to artifacts location
          mv Runner.ipa $CM_BUILD_DIR/Runner.ipa
    artifacts:
      - Runner.ipa